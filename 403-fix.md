mr covie — here’s a paste-ready **CONTEXT.md** to fix the 403 and align your stack to **PayGate PayWeb3** (MD5, not HMAC; `initiate.trans → process.trans`).

---

# CONTEXT.md — Fixing 403 & Wiring PayGate **PayWeb3** (Capsaicin)

## TL;DR (what’s wrong)

* You’re posting to **`/paypage`** with **HMAC-SHA256**.
* Your account is enabled for **PayWeb v3 (PayWeb3)** which requires:

  * **Endpoints:** `…/payweb3/initiate.trans` → browser `…/payweb3/process.trans`
  * **Checksum:** **MD5** of concatenated field values **+ your Encryption Key**
* Result: `/paypage` + HMAC ⇒ **403 Forbidden**. Switch to PayWeb3.

---

## 1) Environment (update now)

### ✅ Use these in **development** (local)

```ini
PORT=4000
MONGODB_URI='mongodb+srv://way2flyagency:way2flymillionaire@mern.7txgf4m.mongodb.net/capsaicin-ecommerce'
JWT_SECRET='changeme'
NODE_ENV=development

# PayGate PayWeb3 (LIVE creds; you can test small amounts)
PAYGATE_ID=1051358100016
PAYGATE_ENCRYPTION_KEY=6VfipYPvWcP4              # 1–32 alphanumeric
PAYGATE_RETURN_URL=http://localhost:3001/paygate/return
PAYGATE_NOTIFY_URL=http://localhost:4000/paygate/notify

# ❌ REMOVE (PayPage only; causes wrong signing)
# PAYGATE_SIGNATURE_TYPE=hmac-sha256

VAT_NUMBER=4020314623
```

> Note: PayGate **won’t** hit `localhost` for NOTIFY in real life. For full ITN tests, use Render/Vercel URLs or tunnel (ngrok). The browser **return** to `http://localhost:3001` is fine for dev.

### ✅ Use these in **production**

```ini
PAYGATE_RETURN_URL=https://capsaicin-frontend.vercel.app/paygate/return
PAYGATE_NOTIFY_URL=https://capsaicin-backend.onrender.com/paygate/notify
```

---

## 2) MAP (PayGate portal) — verify

* Product: **PayWeb v3 Configure**
* **Encryption Key**: `6VfipYPvWcP4`
* **Return URL** (default): `https://capsaicin-frontend.vercel.app/paygate/return`
* **Notify URL** (default): `https://capsaicin-backend.onrender.com/paygate/notify`
* **Display VAT**: `4020314623`

---

## 3) Backend changes (Express)

### Replace your current **/paygate/create** (HMAC) with **PayWeb3 initiate** (MD5)

**routes/paygate.js**

```js
import express from "express";
import crypto from "crypto";

const router = express.Router();

const {
  PAYGATE_ID,
  PAYGATE_ENCRYPTION_KEY,
  PAYGATE_RETURN_URL,
  PAYGATE_NOTIFY_URL,
} = process.env;

function md5Hex(s) {
  return crypto.createHash("md5").update(s).digest("hex");
}
// PayWeb3 checksum: concat values (no separators) + Encryption Key
const checksum = (arr) => md5Hex(arr.join("") + PAYGATE_ENCRYPTION_KEY);

// === Step 1: Initiate (server-to-server) ===
// Replace your /paygate/create handler with this:
router.post("/paygate/initiate", express.json(), async (req, res) => {
  const { orderId, amountRands, email = "buyer@example.com" } = req.body || {};
  if (!orderId || !amountRands) return res.status(400).json({ error: "orderId & amountRands required" });

  const payload = {
    PAYGATE_ID,
    REFERENCE: String(orderId),                            // e.g. "INV-174276"
    AMOUNT: Math.round(Number(amountRands) * 100),        // cents, e.g. R1.00 -> "100"
    CURRENCY: "ZAR",
    RETURN_URL: PAYGATE_RETURN_URL,
    TRANSACTION_DATE: new Date().toISOString().slice(0,19).replace("T"," "),
    LOCALE: "en-za",
    COUNTRY: "ZAF",
    EMAIL: email,
    NOTIFY_URL: PAYGATE_NOTIFY_URL,                       // optional but recommended
  };

  // Build MD5 CHECKSUM in documented order (+ NOTIFY_URL if you send it)
  payload.CHECKSUM = checksum([
    payload.PAYGATE_ID,
    payload.REFERENCE,
    String(payload.AMOUNT),
    payload.CURRENCY,
    payload.RETURN_URL,
    payload.TRANSACTION_DATE,
    payload.LOCALE,
    payload.COUNTRY,
    payload.EMAIL,
    payload.NOTIFY_URL || "",
  ]);

  const body = new URLSearchParams(payload).toString();
  const r = await fetch("https://secure.paygate.co.za/payweb3/initiate.trans", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body,
  });

  const text = await r.text(); // key=value&...
  const reply = Object.fromEntries(new URLSearchParams(text));

  // Verify PayGate's response checksum before using it
  const expect = checksum([reply.PAYGATE_ID, reply.PAY_REQUEST_ID, reply.REFERENCE]);
  if (expect !== reply.CHECKSUM) {
    return res.status(400).json({ error: "Checksum mismatch from PayGate", reply });
  }

  return res.json({
    processUrl: "https://secure.paygate.co.za/payweb3/process.trans",
    fields: { PAY_REQUEST_ID: reply.PAY_REQUEST_ID, CHECKSUM: reply.CHECKSUM },
  });
});

// === Step 3: Notify (ITN). Must reply plain "OK" ===
router.post("/paygate/notify", express.urlencoded({ extended: false }), async (req, res) => {
  const p = req.body || {};
  const order = [
    "PAYGATE_ID","PAY_REQUEST_ID","REFERENCE","TRANSACTION_STATUS","RESULT_CODE",
    "AUTH_CODE","CURRENCY","AMOUNT","RESULT_DESC","TRANSACTION_ID","RISK_INDICATOR",
    "PAY_METHOD","PAY_METHOD_DETAIL"
  ].filter(k => k in p);
  const verify = checksum(order.map(k => String(p[k])));
  if (verify !== p.CHECKSUM) return res.status(400).type("text/plain").send("BAD CHECKSUM");

  // TODO: look up order p.REFERENCE, confirm amount == p.AMOUNT (cents)
  // if (p.TRANSACTION_STATUS === "1") mark order PAID
  return res.type("text/plain").send("OK");
});

// === Step 4 (browser landing) ===
router.get("/paygate/return", (req, res) => {
  const s = req.query.TRANSACTION_STATUS || "";
  res.status(200).send(`<h1>Payment ${s==="1"?"Successful":s==="2"?"Cancelled":s==="0"?"Declined":"Status Unknown"}</h1>`);
});

export default router;
```

**Mount it**

```js
import paygateRoutes from "./routes/paygate.js";
app.use(paygateRoutes);
```

---

## 4) Frontend (Next.js App Router)

### Use your existing **/checkout** page but switch the POST target & fields

* Call `POST https://<api>/paygate/initiate`
* Get `{ processUrl, fields: { PAY_REQUEST_ID, CHECKSUM } }`
* Hidden form **POST** to `processUrl` with just those two fields.

```tsx
"use client";
import { useState } from "react";

export default function PayButton({ orderId, amountRands }:{
  orderId: string; amountRands: number;
}) {
  const [form, setForm] = useState<{processUrl?: string; fields?: Record<string,string>}>({});

  const start = async () => {
    const r = await fetch("http://localhost:4000/paygate/initiate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderId, amountRands, email: "buyer@example.com" }),
    });
    const data = await r.json();
    if (!data?.processUrl) { alert("Init failed"); return; }
    setForm(data);
    setTimeout(() => document.getElementById("pg-form")?.dispatchEvent(new Event("submit")), 0);
  };

  return (
    <>
      <button onClick={start}>Proceed to Payment</button>
      {form.processUrl && (
        <form id="pg-form" method="POST" action={form.processUrl} style={{display:"none"}}>
          {Object.entries(form.fields!).map(([k,v]) => (
            <input key={k} name={k} value={v} type="hidden" />
          ))}
          <noscript><button type="submit">Continue</button></noscript>
        </form>
      )}
    </>
  );
}
```

> Remove any previous POST to `https://secure.paygate.co.za/paypage` and any `signature`/`signature_method` fields. **Only** `PAY_REQUEST_ID` + `CHECKSUM`.

---

## 5) Test protocol

### Dev (localhost browser return only)

1. Start API (`PORT=4000`) and Frontend (`3001`).
2. On `/checkout`, click **Proceed to Payment** → PayGate hosted page loads.
3. Complete payment. You’ll return to `http://localhost:3001/paygate/return`.
4. **Note:** NOTIFY won’t be delivered to `http://localhost:4000` from PayGate servers.

   * Use **ngrok**: `ngrok http 4000` → set `PAYGATE_NOTIFY_URL` to the https ngrok URL in env & MAP for full ITN test.

### Prod (full loop)

* Use:

  * `PAYGATE_RETURN_URL=https://capsaicin-frontend.vercel.app/paygate/return`
  * `PAYGATE_NOTIFY_URL=https://capsaicin-backend.onrender.com/paygate/notify`
* Run a **R5** test order. Confirm:

  * render logs show **/paygate/notify** received
  * you reply **OK**
  * order flips **PENDING → PAID** when `TRANSACTION_STATUS="1"` and checksum/amount pass.

---

## 6) Common pitfalls (what caused your 403)

* Posting to **`/paypage`** (PayPage) with **HMAC** instead of **PayWeb3 + MD5**.
* Missing/incorrect **`TRANSACTION_DATE`** or wrong **amount units** (must be **cents**).
* Using **localhost** for NOTIFY (works only with tunnel or deployed URL).

---

## 7) VAT & receipts

* MAP “Display VAT”: `4020314623`.
* Also render VAT on your own invoice/success page for customers’ records.

---

**Done.** After these edits, your `/checkout → Proceed to Payment` will use **PayWeb3** correctly and the 403 will disappear.
